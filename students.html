<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ILS College - Student Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        }
        
        .modal-overlay {
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        
        .status-chip {
            transition: all 0.2s ease;
        }
        
        .status-chip:hover {
            transform: scale(1.05);
        }
        
        .student-avatar {
            transition: all 0.3s ease;
        }
        
        .student-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.3);
        }
        
        .btn-hover-effect {
            transition: all 0.3s ease;
            transform: translateY(0);
        }
        
        .btn-hover-effect:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(236, 72, 153, 0.3);
        }
        
        .floating-bubble {
            position: absolute;
            border-radius: 50%;
            background: linear-gradient(45deg, rgba(236, 72, 153, 0.1), rgba(147, 51, 234, 0.1));
            animation: float 6s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }
        
        .timeline-item {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1.5rem;
        }
        
        .timeline-item::before {
            content: "";
            position: absolute;
            left: 0.5rem;
            top: 0;
            height: 100%;
            width: 2px;
            background: linear-gradient(to bottom, #ec4899, transparent);
        }
        
        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0.25rem;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background-color: #ec4899;
            border: 2px solid white;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.2);
        }
        
        .progress-fill {
            height: 6px;
            background: linear-gradient(90deg, #ff9ec6, #ff6b9a);
            border-radius: 3px;
            width: 0%;
            transition: width 1s ease;
        }
        
        .loading-shimmer {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(236, 72, 153, 0.3);
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(236, 72, 153, 0.5);
        }
    </style>
</head>
<body class="relative min-h-screen overflow-x-hidden">
    <!-- Floating Bubbles -->
    <div class="floating-bubble w-20 h-20 top-10 left-10" style="animation-delay: 0s;"></div>
    <div class="floating-bubble w-32 h-32 top-40 right-20" style="animation-delay: 2s;"></div>
    <div class="floating-bubble w-16 h-16 bottom-20 left-20" style="animation-delay: 4s;"></div>
    <div class="floating-bubble w-24 h-24 bottom-40 right-40" style="animation-delay: 1s;"></div>
    
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex flex-col lg:flex-row gap-6 mb-8">
            <div class="flex-1">
                <div class="flex justify-between items-center mb-6">
                    <div data-aos="fade-right">
                        <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent">
                            Student Management
                        </h1>
                        <p class="text-gray-600 text-sm mt-2">Manage all student records and activities with real-time updates</p>
                    </div>
                    <button onclick="openAddStudentModal()" class="bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-700 hover:to-purple-700 text-white px-6 py-3 rounded-full flex items-center btn-hover-effect shadow-lg" data-aos="fade-left">
                        <i class="fas fa-plus mr-2"></i>
                        Add Student
                    </button>
                </div>

                <!-- Search and Filters -->
                <div class="glass-card p-6 rounded-2xl mb-6" data-aos="fade-up">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
                        <div class="relative flex-1">
                            <input type="text" id="studentSearch" placeholder="Search students by name, ID, level..." 
                                   class="w-full pl-12 pr-4 py-3 rounded-full border border-gray-200 focus:border-pink-500 focus:ring-pink-500 transition-all duration-300 shadow-sm">
                            <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <select id="levelFilter" class="bg-pink-50 text-sm rounded-full px-4 py-2 outline-none focus:ring-2 focus:ring-pink-500 transition-all duration-300">
                                <option value="all">All Levels</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                            <select id="statusFilter" class="bg-pink-50 text-sm rounded-full px-4 py-2 outline-none focus:ring-2 focus:ring-pink-500 transition-all duration-300">
                                <option value="all">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="on_leave">On Leave</option>
                            </select>
                            <button id="resetFilters" class="text-sm rounded-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors">
                                <i class="fas fa-sync-alt mr-2"></i> Reset
                            </button>
                            <button id="exportData" class="text-sm rounded-full px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 transition-colors">
                                <i class="fas fa-file-export mr-2"></i> Export
                            </button>
                        </div>
                    </div>

                    <!-- Student Table -->
                    <div class="relative overflow-x-auto rounded-lg">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-gray-600 bg-gradient-to-r from-pink-50 to-purple-50">
                                    <th class="px-4 py-4 cursor-pointer" onclick="sortTable('id')">
                                        Student ID <i id="sort-id" class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-4 py-4 cursor-pointer" onclick="sortTable('name')">
                                        Name <i id="sort-name" class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-4 py-4 cursor-pointer" onclick="sortTable('level')">
                                        Level <i id="sort-level" class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-4 py-4 cursor-pointer" onclick="sortTable('classes')">
                                        Classes <i id="sort-classes" class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-4 py-4 cursor-pointer" onclick="sortTable('status')">
                                        Status <i id="sort-status" class="fas fa-sort ml-1"></i>
                                    </th>
                                    <th class="px-4 py-4 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody" class="divide-y divide-gray-100">
                                <!-- Dynamic content will be inserted here -->
                            </tbody>
                        </table>
                        <div id="loadingIndicator" class="hidden text-center py-8">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-pink-600"></div>
                            <p class="mt-2 text-gray-600">Loading students...</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="flex flex-col md:flex-row justify-between items-center mt-6 gap-4">
                        <div class="text-sm text-gray-500">
                            Showing <span id="currentPageItems">1 to 5</span> of <span id="totalStudents">0</span> students
                        </div>
                        <div class="flex space-x-1" id="pagination">
                            <!-- Dynamic pagination buttons -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Sidebar -->
            <div class="w-full lg:w-80 xl:w-96 space-y-6">
                <!-- Quick Stats Card -->
                <div class="glass-card p-6 rounded-2xl" data-aos="fade-up" data-aos-delay="100">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Quick Stats</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-br from-pink-100 to-pink-50 rounded-lg p-4 hover:shadow-lg transition-all">
                            <div class="text-xs text-pink-600 font-medium">Total Students</div>
                            <div class="text-2xl font-bold mt-1" id="totalStudentsStat">0</div>
                            <div class="text-xs text-green-600 mt-1">
                                <i class="fas fa-arrow-up"></i> +12% this month
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-100 to-purple-50 rounded-lg p-4 hover:shadow-lg transition-all">
                            <div class="text-xs text-purple-600 font-medium">Active</div>
                            <div class="text-2xl font-bold mt-1" id="activeStudentsStat">0</div>
                            <div class="text-xs text-green-600 mt-1">
                                <i class="fas fa-arrow-up"></i> +8% this week
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-100 to-blue-50 rounded-lg p-4 hover:shadow-lg transition-all">
                            <div class="text-xs text-blue-600 font-medium">On Leave</div>
                            <div class="text-2xl font-bold mt-1" id="onLeaveStudentsStat">0</div>
                            <div class="text-xs text-yellow-600 mt-1">
                                <i class="fas fa-minus"></i> 2 returning
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-green-100 to-green-50 rounded-lg p-4 hover:shadow-lg transition-all">
                            <div class="text-xs text-green-600 font-medium">New This Month</div>
                            <div class="text-2xl font-bold mt-1" id="newStudentsStat">0</div>
                            <div class="text-xs text-green-600 mt-1">
                                <i class="fas fa-arrow-up"></i> +15% vs last month
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Level Distribution Chart -->
                <div class="glass-card p-6 rounded-2xl" data-aos="fade-up" data-aos-delay="200">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Level Distribution</h3>
                    <canvas id="levelChart" height="200"></canvas>
                </div>

                <!-- Recent Activities -->
                <div class="glass-card p-6 rounded-2xl" data-aos="fade-up" data-aos-delay="300">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">Recent Activities</h3>
                        <button onclick="refreshActivities()" class="text-pink-600 hover:text-pink-800 transition-colors">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div id="recentActivities" class="space-y-3 overflow-y-auto max-h-60 custom-scrollbar">
                        <!-- Dynamic activities will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="addStudentModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl p-8 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent">
                    Add New Student
                </h3>
                <button onclick="closeModal('addStudentModal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="addStudentForm" class="space-y-6">
                <!-- Profile Image Upload -->
                <div class="flex flex-col items-center mb-6">
                    <div class="relative">
                        <img id="addModalAvatar" src="https://static.photos/people/200x200" alt="Student" class="w-24 h-24 rounded-full object-cover border-4 border-pink-100">
                        <input type="file" id="addModalAvatarInput" accept="image/*" class="hidden">
                        <button type="button" onclick="document.getElementById('addModalAvatarInput').click()" 
                                class="absolute bottom-0 right-0 bg-pink-600 text-white rounded-full p-2 hover:bg-pink-700 transition-colors">
                            <i class="fas fa-camera text-sm"></i>
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Click to upload profile photo</p>
                </div>

                <!-- Personal Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">First Name*</label>
                        <input type="text" id="addFirstName" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Last Name*</label>
                        <input type="text" id="addLastName" required 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email*</label>
                    <input type="email" id="addEmail" required 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                        <input type="tel" id="addPhone" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                        <input type="date" id="addDob" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Level*</label>
                        <select id="addLevel" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                            <option value="">Select Level</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Status*</label>
                        <select id="addStatus" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="on_leave">On Leave</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                    <textarea id="addNotes" rows="4" 
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300"
                              placeholder="Any additional notes about the student..."></textarea>
                </div>
                
                <div class="flex justify-end space-x-4 pt-6">
                    <button type="button" onclick="closeModal('addStudentModal')" 
                            class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all duration-300">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-6 py-3 bg-gradient-to-r from-pink-600 to-purple-600 text-white rounded-lg hover:from-pink-700 hover:to-purple-700 transition-all duration-300 btn-hover-effect">
                        <i class="fas fa-save mr-2"></i>Save Student
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Student Modal -->
    <div id="viewStudentModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl p-8 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent">
                    Student Details
                </h3>
                <button onclick="closeModal('viewStudentModal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div id="viewStudentContent">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Edit Student Modal -->
    <div id="editStudentModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl p-8 w-full max-w-lg mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold bg-gradient-to-r from-pink-600 to-purple-600 bg-clip-text text-transparent">
                    Edit Student
                </h3>
                <button onclick="closeModal('editStudentModal')" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <form id="editStudentForm" class="space-y-6">
                <!-- Dynamic content will be inserted here -->
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteStudentModal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center">
        <div class="modal-content bg-white rounded-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
                    <i class="fas fa-exclamation text-red-600 text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">Delete Student</h3>
                <p class="text-gray-600 mb-6">Are you sure you want to delete this student? This action cannot be undone and will permanently remove all associated data.</p>
                <div class="flex justify-center space-x-4">
                    <button type="button" onclick="closeModal('deleteStudentModal')" 
                            class="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-lg transition-all duration-300">
                        Cancel
                    </button>
                    <button type="button" onclick="confirmDeleteStudent()" 
                            class="px-6 py-3 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all duration-300">
                        Delete Student
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBmkrptMlRSMEk2SqKRZ3LQMFGSj1WyJNY",
            authDomain: "eau-sys.firebaseapp.com",
            projectId: "eau-sys",
            storageBucket: "eau-sys.firebasestorage.app",
            messagingSenderId: "756792790977",
            appId: "1:756792790977:web:89a42f8c482b653aa46940",
            measurementId: "G-M13ZKBXQKV"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Global Variables
        let students = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentSort = { column: 'createdAt', direction: 'desc' };
        let studentToDelete = null;
        let currentEditStudent = null;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            AOS.init();
            initializeApp();
            setupEventListeners();
            loadStudents();
            setupCharts();
        });

        // Initialize App
        function initializeApp() {
            // Setup real-time listeners
            setupRealtimeListeners();
            
            // Initialize Feather icons
            feather.replace();
            
            // Show loading indicator
            showLoading(true);
        }

        // Setup Real-time Listeners
        function setupRealtimeListeners() {
            // Listen for students collection changes
            db.collection('students').orderBy('createdAt', 'desc')
                .onSnapshot((snapshot) => {
                    students = [];
                    snapshot.forEach((doc) => {
                        students.push({ id: doc.id, ...doc.data() });
                    });
                    renderStudentTable();
                    updateStats();
                    showLoading(false);
                }, (error) => {
                    console.error('Error loading students:', error);
                    showLoading(false);
                });

            // Listen for activities collection changes
            db.collection('activities').orderBy('timestamp', 'desc').limit(10)
                .onSnapshot((snapshot) => {
                    const activities = [];
                    snapshot.forEach((doc) => {
                        activities.push(doc.data());
                    });
                    renderRecentActivities(activities);
                });
        }

        // Load Students
        async function loadStudents() {
            try {
                const snapshot = await db.collection('students').orderBy('createdAt', 'desc').get();
                students = [];
                snapshot.forEach((doc) => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                renderStudentTable();
                updateStats();
            } catch (error) {
                console.error('Error loading students:', error);
                showNotification('Error loading students', 'error');
            }
        }

        // Render Student Table
        function renderStudentTable() {
            const tableBody = document.getElementById('studentTableBody');
            const filteredStudents = filterAndSortStudents();
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedStudents = filteredStudents.slice(startIndex, endIndex);

            tableBody.innerHTML = '';

            if (paginatedStudents.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-gray-500">
                            <i class="fas fa-user-graduate text-4xl mb-4"></i>
                            <p>No students found</p>
                        </td>
                    </tr>
                `;
                return;
            }

            paginatedStudents.forEach((student, index) => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-pink-50 transition-all duration-300 fade-in';
                row.style.animationDelay = `${index * 0.1}s`;
                
                row.innerHTML = `
                    <td class="px-4 py-4 font-medium text-gray-900">${student.studentId || 'ST-' + student.id.slice(-4)}</td>
                    <td class="px-4 py-4">
                        <div class="flex items-center">
                            <img src="${student.photoUrl || 'https://static.photos/people/40x40'}" 
                                 alt="${student.firstName}" 
                                 class="w-10 h-10 rounded-full mr-3 object-cover student-avatar">
                            <div>
                                <div class="font-medium text-gray-900">${student.firstName} ${student.lastName}</div>
                                <div class="text-sm text-gray-500">${student.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getLevelClass(student.level)}">
                            ${capitalizeFirstLetter(student.level)}
                        </span>
                    </td>
                    <td class="px-4 py-4">
                        <div class="flex items-center">
                            <span class="font-medium">${student.classes || 0}</span>
                            <div class="ml-2 flex-1">
                                <div class="bg-gray-200 rounded-full h-2 w-20">
                                    <div class="progress-fill" style="width: ${Math.min((student.classes || 0) * 20, 100)}%"></div>
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-medium status-chip ${getStatusClass(student.status)}">
                            ${formatStatus(student.status)}
                        </span>
                    </td>
                    <td class="px-4 py-4 text-right">
                        <div class="flex justify-end space-x-2">
                            <button onclick="viewStudent('${student.id}')" 
                                    class="text-pink-600 hover:text-pink-800 p-2 rounded-full hover:bg-pink-100 transition-all duration-300"
                                    title="View Student">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editStudent('${student.id}')" 
                                    class="text-blue-600 hover:text-blue-800 p-2 rounded-full hover:bg-blue-100 transition-all duration-300"
                                    title="Edit Student">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="requestDeleteStudent('${student.id}')" 
                                    class="text-red-600 hover:text-red-800 p-2 rounded-full hover:bg-red-100 transition-all duration-300"
                                    title="Delete Student">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });

            updatePagination(filteredStudents.length);
        }

        // Filter and Sort Students
        function filterAndSortStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const levelFilter = document.getElementById('levelFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = students.filter(student => {
                const matchesSearch = 
                    student.firstName?.toLowerCase().includes(searchTerm) || 
                    student.lastName?.toLowerCase().includes(searchTerm) || 
                    student.studentId?.toLowerCase().includes(searchTerm) ||
                    student.email?.toLowerCase().includes(searchTerm);
                
                const matchesLevel = levelFilter === 'all' || student.level === levelFilter;
                const matchesStatus = statusFilter === 'all' || student.status === statusFilter;
                
                return matchesSearch && matchesLevel && matchesStatus;
            });

            // Sort
            filtered.sort((a, b) => {
                const column = currentSort.column;
                let aValue, bValue;

                if (column === 'name') {
                    aValue = `${a.firstName} ${a.lastName}`.toLowerCase();
                    bValue = `${b.firstName} ${b.lastName}`.toLowerCase();
                } else if (column === 'classes') {
                    return currentSort.direction === 'asc' ? 
                        (a.classes || 0) - (b.classes || 0) : 
                        (b.classes || 0) - (a.classes || 0);
                } else {
                    aValue = a[column]?.toLowerCase() || '';
                    bValue = b[column]?.toLowerCase() || '';
                }

                if (aValue < bValue) return currentSort.direction === 'asc' ? -1 : 1;
                if (aValue > bValue) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            return filtered;
        }

        // Update Pagination
        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            pagination.innerHTML = '';
            
            // Previous button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prevButton.className = `px-3 py-2 rounded-lg transition-colors ${
                currentPage === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-pink-100 text-pink-600 hover:bg-pink-200'
            }`;
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => changePage(currentPage - 1);
            pagination.appendChild(prevButton);

            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = `px-3 py-2 rounded-lg transition-colors ${
                    i === currentPage ? 'bg-pink-600 text-white' : 'bg-pink-100 text-pink-600 hover:bg-pink-200'
                }`;
                pageButton.onclick = () => changePage(i);
                pagination.appendChild(pageButton);
            }

            // Next button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
            nextButton.className = `px-3 py-2 rounded-lg transition-colors ${
                currentPage === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-pink-100 text-pink-600 hover:bg-pink-200'
            }`;
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => changePage(currentPage + 1);
            pagination.appendChild(nextButton);

            // Update page info
            const start = ((currentPage - 1) * itemsPerPage) + 1;
            const end = Math.min(currentPage * itemsPerPage, totalItems);
            document.getElementById('currentPageItems').textContent = `${start} to ${end}`;
            document.getElementById('totalStudents').textContent = totalItems;
        }

        // Change Page
        function changePage(page) {
            currentPage = page;
            renderStudentTable();
        }

        // Sort Table
        function sortTable(column) {
            // Reset all sort icons
            document.querySelectorAll('[id^="sort-"]').forEach(icon => {
                icon.className = 'fas fa-sort ml-1';
            });
            
            // Determine new sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Update sort icon
            const sortIcon = document.getElementById(`sort-${column}`);
            sortIcon.className = `fas fa-sort-${currentSort.direction === 'asc' ? 'up' : 'down'} ml-1`;
            
            // Re-render table
            renderStudentTable();
        }

        // Update Stats
        function updateStats() {
            const total = students.length;
            const active = students.filter(s => s.status === 'active').length;
            const onLeave = students.filter(s => s.status === 'on_leave').length;
            const newThisMonth = students.filter(s => {
                const created = new Date(s.createdAt?.toDate() || Date.now());
                const now = new Date();
                return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
            }).length;

            // Animate numbers
            animateNumber('totalStudentsStat', total);
            animateNumber('activeStudentsStat', active);
            animateNumber('onLeaveStudentsStat', onLeave);
            animateNumber('newStudentsStat', newThisMonth);
        }

        // Animate Number
        function animateNumber(elementId, target) {
            const element = document.getElementById(elementId);
            const start = parseInt(element.textContent) || 0;
            const duration = 1000;
            const startTime = Date.now();

            function update() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const current = Math.floor(start + (target - start) * progress);
                element.textContent = current;
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                }
            }
            
            update();
        }

        // View Student
        async function viewStudent(studentId) {
            try {
                const doc = await db.collection('students').doc(studentId).get();
                if (doc.exists) {
                    const student = { id: doc.id, ...doc.data() };
                    
                    const content = `
                        <div class="flex flex-col items-center mb-6">
                            <img src="${student.photoUrl || 'https://static.photos/people/200x200'}" 
                                 alt="${student.firstName}" 
                                 class="w-24 h-24 rounded-full object-cover mb-4 border-4 border-pink-100">
                            <h4 class="text-2xl font-bold text-gray-900">${student.firstName} ${student.lastName}</h4>
                            <div class="flex items-center mt-2 space-x-2">
                                <span class="text-sm bg-pink-100 text-pink-800 px-3 py-1 rounded-full">
                                    ${student.studentId || 'ST-' + student.id.slice(-4)}
                                </span>
                                <span class="text-sm ${getStatusClass(student.status)} px-3 py-1 rounded-full">
                                    ${formatStatus(student.status)}
                                </span>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">Level</div>
                                <div class="font-semibold text-gray-900">${capitalizeFirstLetter(student.level)}</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">Enrolled Classes</div>
                                <div class="font-semibold text-gray-900">${student.classes || 0}</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">Email</div>
                                <div class="font-semibold text-gray-900">${student.email}</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">Phone</div>
                                <div class="font-semibold text-gray-900">${student.phone || 'N/A'}</div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">Date of Birth</div>
                                <div class="font-semibold text-gray-900">
                                    ${student.dob ? new Date(student.dob).toLocaleDateString() : 'N/A'}
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-lg p-4">
                                <div class="text-sm text-gray-500 mb-1">Join Date</div>
                                <div class="font-semibold text-gray-900">
                                    ${student.createdAt?.toDate().toLocaleDateString() || 'N/A'}
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <h5 class="text-sm font-semibold text-gray-700 mb-2">Additional Notes</h5>
                            <p class="text-gray-600">${student.notes || 'No additional notes available.'}</p>
                        </div>
                        
                        <div class="flex justify-end space-x-4">
                            <button type="button" onclick="closeModal('viewStudentModal')" 
                                    class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all duration-300">
                                Close
                            </button>
                            <button type="button" onclick="editStudent('${student.id}')" 
                                    class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all duration-300">
                                <i class="fas fa-edit mr-2"></i>Edit
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('viewStudentContent').innerHTML = content;
                    openModal('viewStudentModal');
                }
            } catch (error) {
                console.error('Error viewing student:', error);
                showNotification('Error loading student details', 'error');
            }
        }

        // Edit Student
        async function editStudent(studentId) {
            try {
                const doc = await db.collection('students').doc(studentId).get();
                if (doc.exists) {
                    currentEditStudent = { id: doc.id, ...doc.data() };
                    
                    const content = `
                        <div class="flex flex-col items-center mb-6">
                            <div class="relative">
                                <img id="editModalAvatar" src="${currentEditStudent.photoUrl || 'https://static.photos/people/200x200'}" 
                                     alt="${currentEditStudent.firstName}" 
                                     class="w-24 h-24 rounded-full object-cover border-4 border-pink-100">
                                <input type="file" id="editModalAvatarInput" accept="image/*" class="hidden">
                                <button type="button" onclick="document.getElementById('editModalAvatarInput').click()" 
                                        class="absolute bottom-0 right-0 bg-pink-600 text-white rounded-full p-2 hover:bg-pink-700 transition-colors">
                                    <i class="fas fa-camera text-sm"></i>
                                </button>
                            </div>
                            <p class="text-sm text-gray-500 mt-2">Click to change photo</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">First Name*</label>
                                <input type="text" id="editFirstName" required value="${currentEditStudent.firstName}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Last Name*</label>
                                <input type="text" id="editLastName" required value="${currentEditStudent.lastName}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email*</label>
                            <input type="email" id="editEmail" required value="${currentEditStudent.email}"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                <input type="tel" id="editPhone" value="${currentEditStudent.phone || ''}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Date of Birth</label>
                                <input type="date" id="editDob" value="${currentEditStudent.dob || ''}"
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Level*</label>
                                <select id="editLevel" required 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                                    <option value="beginner" ${currentEditStudent.level === 'beginner' ? 'selected' : ''}>Beginner</option>
                                    <option value="intermediate" ${currentEditStudent.level === 'intermediate' ? 'selected' : ''}>Intermediate</option>
                                    <option value="advanced" ${currentEditStudent.level === 'advanced' ? 'selected' : ''}>Advanced</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status*</label>
                                <select id="editStatus" required 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300">
                                    <option value="active" ${currentEditStudent.status === 'active' ? 'selected' : ''}>Active</option>
                                    <option value="inactive" ${currentEditStudent.status === 'inactive' ? 'selected' : ''}>Inactive</option>
                                    <option value="on_leave" ${currentEditStudent.status === 'on_leave' ? 'selected' : ''}>On Leave</option>
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Additional Notes</label>
                            <textarea id="editNotes" rows="4" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-pink-500 focus:border-pink-500 transition-all duration-300"
                                      placeholder="Any additional notes about the student...">${currentEditStudent.notes || ''}</textarea>
                        </div>
                        
                        <div class="flex justify-end space-x-4 pt-6">
                            <button type="button" onclick="closeModal('editStudentModal')" 
                                    class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all duration-300">
                                Cancel
                            </button>
                            <button type="submit" 
                                    class="px-6 py-3 bg-gradient-to-r from-pink-600 to-purple-600 text-white rounded-lg hover:from-pink-700 hover:to-purple-700 transition-all duration-300 btn-hover-effect">
                                <i class="fas fa-save mr-2"></i>Save Changes
                            </button>
                        </div>
                    `;
                    
                    document.getElementById('editStudentForm').innerHTML = content;
                    closeModal('viewStudentModal');
                    openModal('editStudentModal');
                }
            } catch (error) {
                console.error('Error editing student:', error);
                showNotification('Error loading student for editing', 'error');
            }
        }

        // Request Delete Student
        function requestDeleteStudent(studentId) {
            studentToDelete = studentId;
            openModal('deleteStudentModal');
        }

        // Confirm Delete Student
        async function confirmDeleteStudent() {
            if (!studentToDelete) return;
            
            try {
                await db.collection('students').doc(studentToDelete).delete();
                
                // Add activity
                await addActivity('student_deleted', `Deleted student ${studentToDelete}`);
                
                showNotification('Student deleted successfully', 'success');
                closeModal('deleteStudentModal');
                studentToDelete = null;
            } catch (error) {
                console.error('Error deleting student:', error);
                showNotification('Error deleting student', 'error');
            }
        }

        // Add Student
        async function addStudent(studentData) {
            try {
                const docRef = await db.collection('students').add({
                    ...studentData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Add activity
                await addActivity('student_added', `Added new student ${studentData.firstName} ${studentData.lastName}`);
                
                showNotification('Student added successfully', 'success');
                return docRef.id;
            } catch (error) {
                console.error('Error adding student:', error);
                showNotification('Error adding student', 'error');
                throw error;
            }
        }

        // Update Student
        async function updateStudent(studentId, studentData) {
            try {
                await db.collection('students').doc(studentId).update({
                    ...studentData,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Add activity
                await addActivity('student_updated', `Updated student ${studentData.firstName} ${studentData.lastName}`);
                
                showNotification('Student updated successfully', 'success');
            } catch (error) {
                console.error('Error updating student:', error);
                showNotification('Error updating student', 'error');
                throw error;
            }
        }

        // Add Activity
        async function addActivity(type, description) {
            try {
                await db.collection('activities').add({
                    type,
                    description,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch (error) {
                console.error('Error adding activity:', error);
            }
        }

        // Render Recent Activities
        function renderRecentActivities(activities) {
            const container = document.getElementById('recentActivities');
            
            if (activities.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 text-gray-500">
                        <i class="fas fa-bell-slash text-2xl mb-2"></i>
                        <p>No recent activities</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = activities.map(activity => {
                const timestamp = activity.timestamp?.toDate() || new Date();
                const timeAgo = getTimeAgo(timestamp);
                const icon = getActivityIcon(activity.type);
                const color = getActivityColor(activity.type);
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-dot" style="background-color: ${color}"></div>
                        <div class="bg-white rounded-lg p-3 shadow-sm">
                            <p class="text-sm text-gray-800">${activity.description}</p>
                            <p class="text-xs text-gray-500 mt-1">
                                <i class="fas fa-clock mr-1"></i>${timeAgo}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Refresh Activities
        function refreshActivities() {
            const button = event.target.closest('button');
            button.classList.add('animate-spin');
            
            // Simulate refresh
            setTimeout(() => {
                button.classList.remove('animate-spin');
                showNotification('Activities refreshed', 'success');
            }, 1000);
        }

        // Setup Charts
        function setupCharts() {
            // Level Distribution Chart
            const levelCtx = document.getElementById('levelChart');
            if (levelCtx) {
                const levelData = getLevelDistribution();
                
                new Chart(levelCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Beginner', 'Intermediate', 'Advanced'],
                        datasets: [{
                            data: [levelData.beginner, levelData.intermediate, levelData.advanced],
                            backgroundColor: [
                                'rgba(249, 168, 212, 0.8)',
                                'rgba(216, 180, 254, 0.8)',
                                'rgba(167, 139, 250, 0.8)'
                            ],
                            borderColor: [
                                'rgba(249, 168, 212, 1)',
                                'rgba(216, 180, 254, 1)',
                                'rgba(167, 139, 250, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '65%',
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            }
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true,
                            duration: 1000
                        }
                    }
                });
            }
        }

        // Get Level Distribution
        function getLevelDistribution() {
            const distribution = { beginner: 0, intermediate: 0, advanced: 0 };
            students.forEach(student => {
                if (student.level) {
                    distribution[student.level]++;
                }
            });
            return distribution;
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Search and filters
            document.getElementById('studentSearch').addEventListener('input', debounce(renderStudentTable, 300));
            document.getElementById('levelFilter').addEventListener('change', renderStudentTable);
            document.getElementById('statusFilter').addEventListener('change', renderStudentTable);
            document.getElementById('resetFilters').addEventListener('click', resetFilters);
            document.getElementById('exportData').addEventListener('click', exportData);

            // Form submissions
            document.getElementById('addStudentForm').addEventListener('submit', handleAddStudent);
            document.getElementById('editStudentForm').addEventListener('submit', handleEditStudent);

            // Image uploads
            document.getElementById('addModalAvatarInput').addEventListener('change', handleImageUpload);
            document.getElementById('editModalAvatarInput').addEventListener('change', handleImageUpload);

            // Modal close on outside click
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }

        // Handle Add Student
        async function handleAddStudent(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const studentData = {
                firstName: document.getElementById('addFirstName').value,
                lastName: document.getElementById('addLastName').value,
                email: document.getElementById('addEmail').value,
                phone: document.getElementById('addPhone').value,
                dob: document.getElementById('addDob').value,
                level: document.getElementById('addLevel').value,
                status: document.getElementById('addStatus').value,
                notes: document.getElementById('addNotes').value,
                classes: 0,
                studentId: generateStudentId()
            };

            try {
                showLoading(true);
                await addStudent(studentData);
                closeModal('addStudentModal');
                e.target.reset();
                document.getElementById('addModalAvatar').src = 'https://static.photos/people/200x200';
            } catch (error) {
                console.error('Error adding student:', error);
            } finally {
                showLoading(false);
            }
        }

        // Handle Edit Student
        async function handleEditStudent(e) {
            e.preventDefault();
            
            const studentData = {
                firstName: document.getElementById('editFirstName').value,
                lastName: document.getElementById('editLastName').value,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                dob: document.getElementById('editDob').value,
                level: document.getElementById('editLevel').value,
                status: document.getElementById('editStatus').value,
                notes: document.getElementById('editNotes').value
            };

            try {
                showLoading(true);
                await updateStudent(currentEditStudent.id, studentData);
                closeModal('editStudentModal');
                currentEditStudent = null;
            } catch (error) {
                console.error('Error updating student:', error);
            } finally {
                showLoading(false);
            }
        }

        // Handle Image Upload
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const modalId = e.target.id.includes('add') ? 'addModalAvatar' : 'editModalAvatar';
                document.getElementById(modalId).src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Upload Image to Firestore (as base64)
        async function uploadImageToFirestore(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    resolve(e.target.result);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Generate Student ID
        function generateStudentId() {
            const prefix = 'ST';
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.random().toString(36).substr(2, 4).toUpperCase();
            return `${prefix}-${timestamp}-${random}`;
        }

        // Reset Filters
        function resetFilters() {
            document.getElementById('studentSearch').value = '';
            document.getElementById('levelFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            renderStudentTable();
            showNotification('Filters reset', 'info');
        }

        // Export Data
        function exportData() {
            const filteredStudents = filterAndSortStudents();
            const csvContent = convertToCSV(filteredStudents);
            downloadFile(csvContent, 'students.csv', 'text/csv');
            showNotification('Data exported successfully', 'success');
        }

        // Convert to CSV
        function convertToCSV(data) {
            const headers = ['ID', 'First Name', 'Last Name', 'Email', 'Phone', 'Level', 'Status', 'Classes'];
            const rows = data.map(student => [
                student.studentId || student.id,
                student.firstName,
                student.lastName,
                student.email,
                student.phone || '',
                student.level,
                student.status,
                student.classes || 0
            ]);
            
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        // Download File
        function downloadFile(content, filename, contentType) {
            const blob = new Blob([content], { type: contentType });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Modal Functions
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function openAddStudentModal() {
            openModal('addStudentModal');
        }

        // Utility Functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showLoading(show) {
            const indicator = document.getElementById('loadingIndicator');
            if (show) {
                indicator.classList.remove('hidden');
            } else {
                indicator.classList.add('hidden');
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };

            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 slide-in`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function getStatusClass(status) {
            const classes = {
                active: 'bg-green-100 text-green-800',
                inactive: 'bg-red-100 text-red-800',
                on_leave: 'bg-yellow-100 text-yellow-800'
            };
            return classes[status] || 'bg-gray-100 text-gray-800';
        }

        function getLevelClass(level) {
            const classes = {
                beginner: 'bg-blue-100 text-blue-800',
                intermediate: 'bg-purple-100 text-purple-800',
                advanced: 'bg-pink-100 text-pink-800'
            };
            return classes[level] || 'bg-gray-100 text-gray-800';
        }

        function formatStatus(status) {
            const statusMap = {
                active: 'Active',
                inactive: 'Inactive',
                on_leave: 'On Leave'
            };
            return statusMap[status] || status;
        }

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        function getActivityIcon(type) {
            const icons = {
                student_added: 'user-plus',
                student_updated: 'edit',
                student_deleted: 'trash',
                class_enrolled: 'book',
                level_upgraded: 'arrow-up'
            };
            return icons[type] || 'info-circle';
        }

        function getActivityColor(type) {
            const colors = {
                student_added: '#10b981',
                student_updated: '#f59e0b',
                student_deleted: '#ef4444',
                class_enrolled: '#3b82f6',
                level_upgraded: '#8b5cf6'
            };
            return colors[type] || '#6b7280';
        }
    </script>
</body>
</html>
